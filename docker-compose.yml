version: "3"

services:
  emqx:
    image: emqx/emqx
    restart: unless-stopped
    labels:
      com.centurylinklabs.watchtower.enable: "false"
    ports:
      - 18083:18083
      - 1883:1883
      - 8083:8083
    networks:
      - backend

  foxlink-backend:

    # image: ghcr.io/jjyao88/foxlink-api-backend/backend:latest
    build:
      context: .
      dockerfile: backend.Dockerfile
    restart: unless-stopped
    environment:
      # PY_ENV: production
      DAY_SHIFT_BEGIN: "07:40"
      DAY_SHIFT_END: "23:59"
      DATABASE_HOST: mysql
      DATABASE_PORT: 3306
      DATABASE_USER: root
      DATABASE_PASSWORD: AqqhQ993VNto
      DATABASE_NAME: foxlink
      FOXLINK_EVENT_DB_HOSTS: "['140.118.157.12:27001']"
      FOXLINK_EVENT_DB_USER: root
      FOXLINK_EVENT_DB_PWD: 123456
      JWT_SECRET: secret
      MQTT_BROKER: emqx
      MQTT_PORT: 1883
    ports:
      - 8080:80
    depends_on:
      - emqx
      - mysql
    networks:
      - backend
    extra_hosts:
      - "host.docker.internal:host-gateway"

  foxlink-daemon:
    restart: unless-stopped
    build:
      context: .
      dockerfile: daemon.Dockerfile
    environment:
      # PY_ENV: production
      DAY_SHIFT_BEGIN: "07:40"
      DAY_SHIFT_END: "23:59"
      DATABASE_HOST: mysql
      DATABASE_PORT: 3306
      DATABASE_USER: root
      DATABASE_PASSWORD: AqqhQ993VNto
      DATABASE_NAME: foxlink
      FOXLINK_EVENT_DB_HOSTS: "['140.118.157.12:27001']"
      FOXLINK_EVENT_DB_USER: root
      FOXLINK_EVENT_DB_PWD: 123456
      JWT_SECRET: secret
      MQTT_BROKER: emqx
      MQTT_PORT: 1883
    depends_on:
      - foxlink-backend
    networks:
      - backend
    extra_hosts:
      - "host.docker.internal:host-gateway"

  mysql:
    image: mysql:8
    restart: unless-stopped
    labels:
      com.centurylinklabs.watchtower.enable: "false"
    environment:
      MYSQL_DATABASE: foxlink
      MYSQL_ROOT_PASSWORD: AqqhQ993VNto
    ports:
      - 27001:3306
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - backend

  incubator:
    restart: unless-stopped
    image: incubator:latest
    # build:
    #   context: .
    #   dockerfile: incubator.Dockerfile
    # stdin_open: true
    tty: true
    environment:
      # PY_ENV: production
      PROJECT_ENV: env/od.env

      DAY_SHIFT_BEGIN: "00:01"
      DAY_SHIFT_END: "23:59"

      DATABASE_HOST: mysql-test
      DATABASE_PORT: 3306
      DATABASE_USER: root
      DATABASE_PASSWORD: AqqhQ993VNto
      DATABASE_NAME: testing_api
      # DATABASE_NAME: foxlink

      FOXLINK_EVENT_DB_HOSTS: "['mysql-test']"
      FOXLINK_EVENT_DB_USER: root
      FOXLINK_EVENT_DB_PWD: AqqhQ993VNto
      FOXLINK_EVENT_DB_NAME: testing_foxlink
      FOXLINK_EVENT_DB_TABLE: foxlinkevents

      FOXLINK_DEVICE_DB_HOST: '140.118.157.9:27001'
      FOXLINK_DEVICE_DB_USER: root
      FOXLINK_DEVICE_DB_PWD: AqqhQ993VNto
      FOXLINK_DEVICE_DB_NAME: sfc

      MQTT_BROKER: emqx
      MQTT_PORT: 1883

      JWT_SECRET: secret

    networks:
      - backend
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - .:/code/

  # watchtower:
  #   image: containrrr/watchtower
  #   command: --interval 30
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     - ./watchtower-config.json:/config.json

  mysql-test:
    #### Initialize ###
    # build:
    # context: .
    # dockerfile: testdb.Dockerfile
    #### For each Scenario ####
    image: mysql-test:small
    restart: unless-stopped
    tty: true
    labels:
      com.centurylinklabs.watchtower.enable: "false"
    environment:
      MYSQL_DATABASE: foxlink
      MYSQL_ROOT_PASSWORD: AqqhQ993VNto
    ports:
      - 27001:3306
    networks:
      - backend

networks:
  backend:
    driver: bridge

volumes:
  mysql-data:
  mysql-test:
  mysql-test-sample:
